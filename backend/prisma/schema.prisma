generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===== AUTHENTIFICATION =====

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  password      String
  nom           String
  role          String         @default("user")
  roleId        Int?           // Référence au modèle Role
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  refreshTokens RefreshToken[]
  permissions   UserPermission[]
  roleData      Role?          @relation(fields: [roleId], references: [id], onDelete: SetNull)
  
  @@index([email])
  @@index([roleId])
}

model RefreshToken {
  id          Int      @id @default(autoincrement())
  token       String   @unique
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// ===== SYSTÈME DE RÔLES ET PERMISSIONS =====

model Role {
  id            Int            @id @default(autoincrement())
  name          String         @unique // Ex: "admin", "manager", "cashier"
  displayName   String         // Nom d'affichage: "Administrateur", "Gestionnaire"
  description   String?
  level         Int            @default(0) // Niveau de hiérarchie (plus élevé = plus de pouvoir)
  parentRoleId  Int?           // Rôle parent pour l'héritage
  isSystem      Boolean        @default(false) // Rôle système (non supprimable)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  users         User[]
  permissions   RolePermission[]
  parentRole    Role?          @relation("RoleHierarchy", fields: [parentRoleId], references: [id], onDelete: SetNull)
  childRoles    Role[]         @relation("RoleHierarchy")
  
  @@index([name])
  @@index([level])
  @@index([parentRoleId])
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique // Ex: "products:create", "sales:read"
  description String?
  category    String           // Ex: "products", "sales", "users"
  createdAt   DateTime         @default(now())
  
  users       UserPermission[]
  roles       RolePermission[]
  
  @@index([category])
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  grantedAt    DateTime   @default(now())
  grantedBy    Int?       // ID de l'admin qui a accordé la permission
  
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserPermission {
  id           Int        @id @default(autoincrement())
  userId       Int
  permissionId Int
  grantedAt    DateTime   @default(now())
  grantedBy    Int?       // ID de l'admin qui a accordé la permission
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// ===== BUSINESS MODELS (inchangés) =====

model Product {
  id          Int      @id @default(autoincrement())
  nom         String
  code        String   @unique
  categorie   String
  fournisseur String?
  prixAchat   Float
  prixVente   Float
  stock       Int
  stockMin    Int      @default(5)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sales       Sale[]
  
  @@index([code])
  @@index([categorie])
}

model Client {
  id          Int      @id @default(autoincrement())
  nom         String
  telephone   String   @unique
  credit      Float    @default(0)
  achatsTotal Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sales       Sale[]
  credits     Credit[]
  
  @@index([telephone])
}

model Sale {
  id           Int      @id @default(autoincrement())
  productId    Int
  product      Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  clientId     Int?
  client       Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  quantite     Int
  prixUnitaire Float
  total        Float
  typeVente    String
  date         DateTime @default(now())
  createdAt    DateTime @default(now())
  
  @@index([productId])
  @@index([clientId])
  @@index([date])
  @@index([typeVente])
}

model Credit {
  id             Int      @id @default(autoincrement())
  clientId       Int
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  montant        Float
  montantRestant Float
  dateCredit     DateTime @default(now())
  echeance       DateTime
  statut         String   @default("En cours")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([clientId])
  @@index([statut])
  @@index([echeance])
}

model Expense {
  id          Int      @id @default(autoincrement())
  description String
  montant     Float
  categorie   String
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  
  @@index([categorie])
  @@index([date])
}